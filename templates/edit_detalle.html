<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Editar o Facturar detalle</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.26/jspdf.plugin.autotable.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const { jsPDF } = window.jspdf;

            document.getElementById('convertir-pdf').addEventListener('click', function() {
                const doc = new jsPDF();
                const imgUrl = '{{ url_for('static', filename='descarga.png') }}';
                const img = new Image();
                img.crossOrigin = 'Anonymous';

                img.onload = function() {
                    // Generar número de factura
                    const numeroFactura = `FAC-${generateRandomNumber(2)}-${generateRandomNumber(2)}-${generateRandomNumber(6)}`;
                    
                    // Encabezado
                    doc.setFontSize(12);
                    doc.text(`Número de Factura: ${numeroFactura}`, doc.internal.pageSize.width / 2, 10, { align: 'center' });
                    doc.text('GE Appliances', doc.internal.pageSize.width / 2, 20, { align: 'center' });
                    doc.text('Cai: 1DD33D-68CDOE-BF60E0-63BE03-09092D-96', doc.internal.pageSize.width / 2, 30, { align: 'center' });
                    doc.text('Rango de inicio: 029-001-01-06460001', doc.internal.pageSize.width / 2, 40, { align: 'center' });
                    doc.text('Rango final: 029-001-01-06780001', doc.internal.pageSize.width / 2, 50, { align: 'center' });

                    // Imagen
                    doc.addImage(img, 'PNG', doc.internal.pageSize.width - 50, 5, 40, 20);

                    // Fondo gris
                    doc.setFillColor(240, 240, 240); // Gris claro
                    doc.rect(10, 55, 190, doc.internal.pageSize.height - 65, 'F');

                    // Tabla de detalles
                    const total = parseFloat(document.getElementById('total').value);
                    const totalEnLetras = convertirNumeroALetras(total);

                    doc.autoTable({
                        head: [['Campo', 'Valor']],
                        body: [
                            ['Pedido', document.getElementById('id_pedido').selectedOptions[0].text],
                            ['Producto', document.getElementById('id_producto').selectedOptions[0].text],
                            ['Cantidad', document.getElementById('cantidad').value],
                            ['Precio Unitario', document.getElementById('precio_unitario').value],
                            ['Subtotal', document.getElementById('subtotal').value],
                            ['Impuesto', document.getElementById('id_impuesto').selectedOptions[0].text],
                            ['Total', total.toFixed(2)]
                        ],
                        startY: 60,
                        theme: 'striped'
                    });

                    // Texto del total en letras
                    const footerY = doc.autoTable.previous.finalY + 10;
                    doc.text(`Total en letras: ${totalEnLetras}`, 10, footerY, { align: 'left' });

                    // Fecha y hora actual
                    const today = new Date();
                    const dateStr = `${today.getDate().toString().padStart(2, '0')}/${(today.getMonth() + 1).toString().padStart(2, '0')}/${today.getFullYear()}`;
                    const timeStr = `${today.getHours().toString().padStart(2, '0')}:${today.getMinutes().toString().padStart(2, '0')}`;

                    // Pie de página
                    doc.text('Dirección: Honduras, Distrito Central, Colonia Los Llanos calle 13', doc.internal.pageSize.width / 2, footerY + 20, { align: 'center' });
                    doc.text('Correo: grupo2@gmail.com', doc.internal.pageSize.width / 2, footerY + 30, { align: 'center' });
                    doc.text('Telefono: 9618-7469', doc.internal.pageSize.width / 2, footerY + 40, { align: 'center' });
                    doc.text(`Fecha de creación: ${dateStr} ${timeStr}`, doc.internal.pageSize.width / 2, footerY + 50, { align: 'center' });

                    // Guardar PDF
                    doc.save('Factura.pdf');
                };
                img.src = imgUrl;
            });

            function generateRandomNumber(length) {
                return Math.random().toString().slice(2, 2 + length).padStart(length, '0');
            }

            function convertirNumeroALetras(num) {
                // (El resto del código para convertir número a letras permanece igual)
                if (num === 0) return 'cero';
                if (num < 0) return 'menos ' + convertirNumeroALetras(Math.abs(num));

                const unidades = ['cero', 'uno', 'dos', 'tres', 'cuatro', 'cinco', 'seis', 'siete', 'ocho', 'nueve'];
                const decenas = ['diez', 'once', 'doce', 'trece', 'catorce', 'quince', 'dieciséis', 'diecisiete', 'dieciocho', 'diecinueve'];
                const decenas10 = ['veinte', 'veintiuno', 'veintidós', 'veintitrés', 'veinticuatro', 'veinticinco', 'veintiséis', 'veintisiete', 'veintiocho', 'veintinueve'];
                const decenas20 = ['treinta', 'cuarenta', 'cincuenta', 'sesenta', 'setenta', 'ochenta', 'noventa'];
                const centenas = ['ciento', 'doscientos', 'trescientos', 'cuatrocientos', 'quinientos', 'seiscientos', 'setecientos', 'ochocientos', 'novecientos'];
                const miles = ['mil'];

                if (num < 10) return unidades[num];
                if (num < 20) return decenas[num - 10];
                if (num < 30) return decenas10[num - 20];
                if (num < 100) return decenas20[Math.floor(num / 10) - 2] + (num % 10 !== 0 ? ' y ' + unidades[num % 10] : '');
                if (num < 1000) return (num === 100 ? 'cien' : centenas[Math.floor(num / 100) - 1] + (num % 100 !== 0 ? ' ' + convertirNumeroALetras(num % 100) : ''));
                if (num < 10000) return (Math.floor(num / 1000) === 1 ? 'mil' : convertirNumeroALetras(Math.floor(num / 1000)) + ' mil') + (num % 1000 !== 0 ? ' ' + convertirNumeroALetras(num % 1000) : '');
                if (num < 100000) return convertirNumeroALetras(Math.floor(num / 1000)) + ' mil' + (num % 1000 !== 0 ? ' ' + convertirNumeroALetras(num % 1000) : '');
                if (num === 100000) return 'cien mil';

                return 'Número demasiado grande para convertir';
            }
        });

        function fetchPrecioUnitario() {
            var idProducto = document.getElementById('id_producto').value;
            fetch(`/get_precio/${idProducto}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('precio_unitario').value = data.precio_unitario;
                    calcularSubtotalYTotal();
                });
        }

        function calcularSubtotalYTotal() {
            var cantidad = parseFloat(document.getElementById('cantidad').value);
            var precioUnitario = parseFloat(document.getElementById('precio_unitario').value);
            var subtotal = cantidad * precioUnitario;
            document.getElementById('subtotal').value = subtotal.toFixed(2);

            var idImpuesto = document.getElementById('id_impuesto').value;
            var tasaImpuesto = parseFloat(document.querySelector(`#id_impuesto option[value="${idImpuesto}"]`).textContent);
            var total = subtotal * (1 + tasaImpuesto / 100);
            document.getElementById('total').value = total.toFixed(2);
        }
    </script>
</head>
<body>
    <div class="container">
        <h1>Editar Detalle de Compra</h1>
        <form action="{{ url_for('edit_detalle', id_detalle=detalle[0]) }}" method="post">
            <label for="id_pedido">Pedido:</label>
            <select name="id_pedido" id="id_pedido">
                {% for pedido in pedidos %}
                    <option value="{{ pedido[0] }}" {% if pedido[0] == detalle[1] %} selected {% endif %}>{{ pedido[0] }}</option>
                {% endfor %}
            </select>
            <br>
            <label for="id_producto">Producto:</label>
            <select name="id_producto" id="id_producto" onchange="fetchPrecioUnitario()">
                {% for producto in productos %}
                    <option value="{{ producto[0] }}" {% if producto[0] == detalle[2] %} selected {% endif %}>{{ producto[1] }}</option>
                {% endfor %}
            </select>
            <br>
            <label for="cantidad">Cantidad:</label>
            <input type="number" name="cantidad" id="cantidad" value="{{ detalle[3] }}" oninput="calcularSubtotalYTotal()">
            <br>
            <label for="precio_unitario">Precio Unitario:</label>
            <input type="text" name="precio_unitario" id="precio_unitario" value="{{ detalle[4] }}">
            <br>
            <label for="subtotal">Subtotal:</label>
            <input type="text" name="subtotal" id="subtotal" value="{{ detalle[5] }}">
            <br>
            <label for="id_impuesto">Impuesto:</label>
            <select name="id_impuesto" id="id_impuesto" onchange="calcularSubtotalYTotal()">
                {% for impuesto in impuestos %}
                    <option value="{{ impuesto[0] }}" {% if impuesto[0] == detalle[6] %} selected {% endif %}>{{ impuesto[1] }}</option>
                {% endfor %}
            </select>
            <br>
            <label for="total">Total:</label>
            <input type="text" name="total" id="total" value="{{ detalle[7] }}">
            <br>
            <button type="submit">Actualizar Detalle</button>
            <br>
            <br>
            <button type="button" id="convertir-pdf">Facturar</button>
        </form>
        <a href="{{ url_for('detalles') }}">Volver</a>
    </div>
</body>
</html>
