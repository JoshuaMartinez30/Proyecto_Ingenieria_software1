<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Nuevo Detalle de Compra</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script>
        function calculateSubtotal() {
            var cantidad = parseFloat(document.getElementById('cantidad').value) || 0;
            var precio_unitario = parseFloat(document.getElementById('precio_unitario').value) || 0;
            var subtotal = cantidad * precio_unitario;
            document.getElementById('subtotal').value = subtotal.toFixed(2);
            calculateTotal();
        }

        function calculateTotal() {
            var subtotal = parseFloat(document.getElementById('subtotal').value) || 0;
            var impuesto = parseFloat(document.getElementById('id_impuesto').selectedOptions[0].dataset.tasa) || 0;
            var total = (subtotal * impuesto) + (subtotal);
            document.getElementById('total').value = total.toFixed(2);
        }

        function updatePrecioUnitario() {
            var id_producto = document.getElementById('id_producto').value;
            if (id_producto) {
                fetch('/get_precio/' + id_producto)
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('precio_unitario').value = data.precio_unitario.toFixed(2);
                        calculateSubtotal();
                    })
                    .catch(error => console.error('Error:', error));
            }
        }
    </script>
</head>
<body>
    <div class="container">
    
        <h1>Nuevo Detalle de Compra</h1>
        <form action="{{ url_for('submit_detalle') }}" method="post">
            <label for="id_pedido">Pedido:</label>
            <select id="id_pedido" name="id_pedido" required>
                <option value="">Selecciona un pedido</option>
                {% for pedido in pedidos %}
                    <option value="{{ pedido[0] }}">{{ pedido[0] }}</option>
                {% endfor %}
            </select><br>

            <label for="id_producto">Producto:</label>
            <select id="id_producto" name="id_producto" onchange="updatePrecioUnitario()" required>
                <option value="">Selecciona un producto</option>
                {% for producto in productos %}
                    <option value="{{ producto[0] }}">{{ producto[1] }}</option>
                {% endfor %}
            </select><br>

            <label for="cantidad">Cantidad:</label>
            <input type="number" id="cantidad" name="cantidad" step="any" oninput="calculateSubtotal()" required><br>

            <label for="precio_unitario">Precio Unitario:</label>
            <input type="number" id="precio_unitario" name="precio_unitario" step="any" readonly required><br>

            <label for="subtotal">Subtotal:</label>
            <input type="number" id="subtotal" name="subtotal" step="any" readonly><br>

            <label for="id_impuesto">Impuesto:</label>
            <select id="id_impuesto" name="id_impuesto" onchange="calculateTotal()" required>
                <option value="">Selecciona un impuesto</option>
                {% for impuesto in impuestos %}
                    <option value="{{ impuesto[0] }}" data-tasa="{{ impuesto[1] }}">{{ impuesto[1] }}%</option>
                {% endfor %}
            </select><br>

            <label for="total">Total:</label>
            <input type="money" id="total" name="total" step="any" readonly><br>

            <input type="submit" value="Guardar">
        </form>
        <a href="{{ url_for('detalles_p') }}">Ver detalles de Compra</a>
    </div>
</body>
</html>
